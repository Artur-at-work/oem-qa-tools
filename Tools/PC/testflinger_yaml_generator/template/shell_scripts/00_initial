set -x
sudo add-apt-repository ppa:checkbox-dev/beta -y
sudo apt-get update
sudo DEBIAN_FRONTEND=noninteractive apt-get install jq checkbox-ng -y

TARGET_DEVICE_USERNAME=ubuntu
# convenience functions
SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
# shellcheck disable=SC1054,SC2086
_put() {{
    scp $SSH_OPTS "$1" $TARGET_DEVICE_USERNAME@"$DEVICE_IP":"$2"
}}
# shellcheck disable=SC1054,SC2086
_get() {{
    scp $SSH_OPTS $TARGET_DEVICE_USERNAME@"$DEVICE_IP":"$1" "$2"
}}
# shellcheck disable=SC1054,SC2086
_run() {{
    ssh -t $SSH_OPTS $TARGET_DEVICE_USERNAME@"$DEVICE_IP" "$@"
}}
# shellcheck disable=SC1054,SC2086
_run_in_bg() {{
    ssh -f -t $SSH_OPTS $TARGET_DEVICE_USERNAME@"$DEVICE_IP" "$@"
}}
# shellcheck disable=SC1054,SC2086
wait_for_ssh() {{
    loopcnt=0
    until timeout 120 ssh $SSH_OPTS $TARGET_DEVICE_USERNAME@"$DEVICE_IP" /bin/true
    do
        echo "Testing to see if system is back up"
        loopcnt=$((loopcnt+1))
        if [ $loopcnt -gt 40 ]; then
            echo "ERROR: Timeout waiting for ssh!"
            exit 1
        fi
        sleep 30
    done
}}

#CHECKBOX_CLI_CMD="checkbox-cli"  # assume deb

echo
echo "====== TARGET DEVICE CONNECTION INFO ======"
echo
echo DEVICE_IP: $TARGET_DEVICE_USERNAME@"$DEVICE_IP"
echo
echo "==========================================="
echo

# TODO: if not installed on DUT, then version is the error message
# If we always update the DUT's version, then agent gets the same from beta?
# why checkout to specific version? is it for edge channel?

#CHECKBOX_VERSION=$(_run $CHECKBOX_CLI_CMD --version)
#echo "$CHECKBOX_VERSION"
#git clone --depth=1 https://github.com/canonical/hwcert-jenkins-tools.git > /dev/null
#git clone --filter=tree:0 https://github.com/canonical/checkbox.git > /dev/null
#hwcert-jenkins-tools/version-published/checkout_to_version.py ~/checkbox "$CHECKBOX_VERSION"
#(cd checkbox/checkbox-ng || return; sudo python3 setup.py install > /dev/null)

_run sudo amixer set Master unmute
_run sudo amixer set Master 100
_run sudo amixer set Speaker 100
_run sudo amixer -c 1 set Master unmute
_run sudo amixer -c 1 set Master 100
_run sudo amixer -c 1 set Speaker 100

_run gsettings set org.gnome.desktop.screensaver ubuntu-lock-on-suspend false
_run gsettings set org.gnome.desktop.screensaver lock-enabled false
_run gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-ac-type 'nothing'
_run gsettings set org.gnome.settings-daemon.plugins.power sleep-inactive-battery-type 'nothing'
_run gsettings set org.gnome.desktop.session idle-delay 'uint32 0'

